{% extends 'base.html' %}

{% block title %}Materiales del Curso{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-file"></i> Materiales</h2>
            <p class="text-muted">{{ course.title }}</p>
        </div>
        {% if can_manage %}
        <a href="{% url 'units:unit_list' course.id %}" class="btn btn-success">
            <i class="fas fa-book-open"></i> Ver Unidades
        </a>
        {% endif %}
    </div>

    {% if materials %}
    <div class="row">
        {% for material in materials %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{{ material.title }}</h5>
                    {% if material.material_type == 'file' %}
                    <span class="badge bg-primary">
                        <i class="fas fa-file"></i> Archivo
                    </span>
                    {% else %}
                    <span class="badge bg-info">
                        <i class="fas fa-link"></i> Enlace
                    </span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if material.description %}
                    <p class="card-text">{{ material.description|truncatewords:15 }}</p>
                    {% endif %}

                    {% if material.material_type == 'file' and material.original_filename %}
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-file"></i> {{ material.original_filename }}
                        </small>
                    </div>
                    {% endif %}

                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-user"></i> Subido por: {{ material.uploaded_by.get_full_name|default:material.uploaded_by.username }}
                        </small>
                    </div>

                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> {{ material.uploaded_at|date:"d/m/Y" }}
                        </small>
                    </div>

                    {% if material.material_type == 'file' and material.file_size %}
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-weight"></i> {{ material.file_size|filesizeformat }}
                        </small>
                    </div>
                    {% endif %}

                    {% if material.unit %}
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-book-open"></i> Unidad: {{ material.unit.title }}
                        </small>
                    </div>
                    {% endif %}

                    <div class="mb-2">
                        <span class="badge bg-secondary">
                            {{ material.get_visibility_display }}
                        </span>
                    </div>
                </div>
                <div class="card-footer">
                    {% if material.material_type == 'file' %}
                    <a href="{% url 'materials:material-download' material.id %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download"></i> Descargar
                    </a>
                    {% else %}
                    <a href="{{ material.link_url }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-info btn-sm external-link-warning" data-link-url="{{ material.link_url }}">
                        <i class="fas fa-external-link-alt"></i> Abrir Enlace
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center mt-5">
        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
        <h4>No hay materiales disponibles</h4>
        <p class="text-muted">No se encontraron materiales para este curso.</p>
        {% if can_manage %}
        <a href="{% url 'units:unit_list' course.id %}" class="btn btn-primary">
            <i class="fas fa-book-open"></i> Ver Unidades
        </a>
        {% endif %}
    </div>
    {% endif %}

    <div class="mt-4">
        <a href="{% url 'course_detail' course.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver al Curso
        </a>
    </div>
</div>

{% block extra_js %}
<script>
// Warning for external links
document.querySelectorAll('.external-link-warning').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const url = this.getAttribute('data-link-url') || this.getAttribute('href');
        const message = 'Estás a punto de salir de la plataforma y acceder a un enlace externo.\n\n' +
                       'URL: ' + url + '\n\n' +
                       '¿Deseas continuar?';
        if (confirm(message)) {
            window.open(url, '_blank', 'noopener,noreferrer');
        }
    });
});
</script>
{% endblock %}
{% endblock %}
